# Исправление проблем админ панели на продакшене

## Проблема
На продакшене не работает чтение и установка актуальных данных из админ панели.

## Исправленные проблемы

### 1. CORS настройки
- ✅ Улучшена обработка ALLOWED_ORIGINS
- ✅ Добавлено детальное логирование блокированных запросов
- ✅ Если ALLOWED_ORIGINS не установлен, разрешены все домены

### 2. Cookie настройки для HTTPS
- ✅ Изменен `sameSite` с 'none' на 'strict' для продакшена
- ✅ Добавлена поддержка COOKIE_DOMAIN
- ✅ Добавлено логирование настроек cookie

### 3. Аутентификация
- ✅ Улучшено логирование процесса аутентификации
- ✅ Добавлена диагностика сессий
- ✅ Улучшена обработка ошибок авторизации

### 4. База данных
- ✅ Добавлена диагностика подключения к БД
- ✅ Приложение останавливается если БД недоступна
- ✅ Поддержка настройки пути к БД через DB_PATH

### 5. Debug endpoint
- ✅ Добавлен `/api/debug` для диагностики (требует авторизации)

## Инструкции для деплоя

### 1. Создайте .env файл на продакшене
```bash
# Скопируйте env_example.txt в .env
cp env_example.txt .env
```

### 2. Настройте переменные окружения
Отредактируйте `.env` файл:

```env
# Server configuration  
PORT=3000
NODE_ENV=production

# Admin credentials (ОБЯЗАТЕЛЬНО!)
ADMIN_USERNAME=admin
ADMIN_PASSWORD=ваш_сложный_пароль

# CORS settings (ОБЯЗАТЕЛЬНО!)
ALLOWED_ORIGINS=https://ваш-домен.com,https://www.ваш-домен.com

# Cookie settings (опционально)
COOKIE_DOMAIN=ваш-домен.com
```

### 3. Проверьте права доступа
```bash
# Убедитесь что app.db доступна для записи
chmod 664 app.db
ls -la app.db
```

### 4. Перезапустите сервер
```bash
# Остановите сервер
pm2 stop coming-soon  # или ваш способ

# Запустите заново
pm2 start server.js --name coming-soon
# или
node server.js
```

## Диагностика проблем

### 1. Проверьте логи сервера
Логи теперь более детальные и покажут:
- CORS блокировки
- Проблемы с аутентификацией
- Ошибки базы данных

### 2. Используйте debug endpoint
После авторизации в админ панели откройте:
```
https://ваш-домен.com/api/debug
```

Это покажет:
- Настройки окружения
- Активные сессии
- Заголовки запросов
- Путь к БД

### 3. Health check
```
https://ваш-домен.com/api/health
```

## Возможные проблемы и решения

### Проблема: "CORS error" 
**Решение:** Убедитесь что ALLOWED_ORIGINS содержит ваш домен с правильным протоколом (https://)

### Проблема: "Unauthorized" после логина
**Решение:** 
1. Проверьте что ADMIN_USERNAME и ADMIN_PASSWORD правильно установлены
2. Убедитесь что cookie сохраняются (проверьте Developer Tools)

### Проблема: "Database error"
**Решение:**
1. Проверьте права доступа к app.db
2. Убедитесь что путь к БД корректен

### Проблема: Админ панель не загружается
**Решение:**
1. Откройте /api/health для проверки работы сервера
2. Проверьте HTTPS сертификат
3. Убедитесь что NODE_ENV=production

## Контакты
Если проблемы продолжаются, проверьте логи сервера - они теперь намного более информативны.
